<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard – Ozark Invitational</title>

  <!-- Site-wide styles & scripts (for topbar, buttons, etc.) -->
  <link rel="stylesheet" href="styles.css" />
  <script src="script.js" defer></script>

  <style>
    :root{
      --green:#244f3c; --green-dark:#163023; --gold:#d1a14b; --cream:#f5f0e6; --bg:#fcfaf6; --text:#222;
      --panel:#ffffff; --line:#e7e0d1;
      --radius:14px; --shadow:0 14px 38px rgba(0,0,0,.06);
      --oz:#2ecc71; --va:#3498db;
    }

    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",sans-serif}

    .wrap{max-width:1100px;margin:88px auto 20px;padding:12px}

    .hdr{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;border-radius:999px;background:var(--green);color:#fff;display:grid;place-items:center;font-weight:800}
    .title{font-weight:800;letter-spacing:-.01em}
    .sub{opacity:.7;font-size:.9rem;margin-top:-2px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--green);color:#fff;border:none;border-radius:999px;padding:.5rem 1rem;font-weight:700;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--green);border:1px solid var(--green)}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .card .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#fff}
    .card .body{padding:12px 14px}

    .totals{display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center}
    .teamBox{display:flex;flex-direction:column;gap:6px}
    .teamName{font-weight:800;letter-spacing:.02em}
    .teamScore{font-size:2rem;font-weight:900}
    .bar{height:14px;background:#eee;border-radius:999px;overflow:hidden;border:1px solid #ddd}
    .bar > div{height:100%}

    .filters{display:flex;gap:8px;flex-wrap:wrap}
    select{padding:.5rem .7rem;border:1px solid #d9d2c4;border-radius:10px;background:#fff;font:inherit}

    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #ece6d6;padding:.55rem .6rem;font-size:.95rem;text-align:left}
    .table thead th{background:#f7f4ec;font-weight:800}
    .muted{opacity:.7}

    .badge{border:1px solid #d9d2c4;border-radius:999px;padding:.2rem .5rem;background:#fff;font-size:.75rem}
    .pill{border:1px solid #d9d2c4;border-radius:999px;padding:.15rem .5rem;background:#fff;font-size:.75rem}

    .winner{font-weight:800}
    .oz{color:var(--green-dark)}
    .va{color:#1b4d80}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px}
    .dot.oz{background:var(--oz)}
    .dot.va{background:var(--va)}

    .small{font-size:.85rem}

    @media print{
      .topbar, .actions, .filters{display:none}
      .wrap{max-width:none;margin:0;padding:0}
      .card{box-shadow:none;border:1px solid #bbb;border-radius:10px}
      .card .head{background:#fff;border-bottom:1px solid #ddd}
    }
  </style>
</head>
<body>

  <!-- Shared site header / nav -->
  <header class="topbar">
    <div class="logo-wrap">
      <div class="logo-circle">OI</div>
      <div class="logo-text">
        <span class="title">Ozark Invitational</span>
        <span class="subtitle">Family Golf Tournament</span>
      </div>
    </div>
    <nav class="nav" aria-label="Primary">
      <a href="index.html">Home</a>
      <a href="scorecard.html">Scorecard</a>
      <a href="scoreboard.html">Scoreboard</a>
      <a href="leaderboard.html">Leaderboard</a>
      <a href="index.html#teams">Players</a>
      <a href="index.html#sponsors">Sponsors</a>
      <a href="index.html#signup" class="btn-nav">Sign Up</a>
    </nav>
    <button class="nav-toggle" id="navToggle" aria-label="Toggle menu" aria-expanded="false">☰</button>
  </header>

  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="logo">OI</div>
        <div>
          <div class="title">Ozark Invitational — Leaderboard</div>
          <div class="sub">Live team totals & round-by-round results</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="window.print()">Print</button>
      </div>
    </div>

    <!-- Totals card -->
    <section class="card" style="margin-bottom:12px">
      <div class="head">
        <div class="filters">
          <label class="small">Day
            <select id="fDay">
              <option value="all">All</option>
              <option value="day1">Day 1</option>
              <option value="day2">Day 2</option>
            </select>
          </label>
          <label class="small">Side
            <select id="fSide">
              <option value="all">All</option>
              <option value="front">Front 9</option>
              <option value="back">Back 9</option>
            </select>
          </label>
        </div>
        <div class="badge small" id="eventNameBadge">Event</div>
      </div>
      <div class="body">
        <div class="totals">
          <div class="teamBox">
            <div class="teamName"><span class="dot oz"></span>Team Ozark</div>
            <div class="teamScore" id="scoreOz">0</div>
          </div>

          <div class="bar" aria-label="Match progress">
            <div id="barFill" style="width:50%; background:linear-gradient(90deg, var(--oz), var(--va));"></div>
          </div>

          <div class="teamBox" style="align-items:end;text-align:right">
            <div class="teamName"><span class="dot va"></span>Team Valley</div>
            <div class="teamScore" id="scoreVa">0</div>
          </div>
        </div>
        <div class="small muted" style="margin-top:8px">
          <span class="pill">Team formats: 1 pt</span>
          <span class="pill">Singles matches: 1 pt each</span>
          <span class="pill">Tie: 0.5 / 0.5</span>
        </div>
      </div>
    </section>

    <!-- Results table -->
    <section class="card">
      <div class="head">
        <strong>Round Results</strong>
        <span class="small muted" id="filterNote"></span>
      </div>
      <div class="body">
        <table class="table" id="tbl">
          <thead>
            <tr>
              <th style="width:110px">Day</th>
              <th style="width:110px">Side</th>
              <th style="width:140px">Format</th>
              <th style="width:70px">Group</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Tiny inline helpers for the shared header -->
  <script>
    // Mobile menu toggle
    (function () {
      const btn = document.getElementById('navToggle');
      const nav = document.querySelector('.nav');
      if (!btn || !nav) return;
      btn.addEventListener('click', () => {
        const open = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', String(!open));
        nav.classList.toggle('open', !open);
      });
    })();

    // Current tab highlight (GitHub Pages-safe)
    (function(){
      const here = (location.pathname.split('/').pop() || 'index.html').toLowerCase();
      document.querySelectorAll('.nav a').forEach(a => {
        const target = (a.getAttribute('href') || '').split('#')[0] || 'index.html';
        if (target.toLowerCase() === here) a.setAttribute('aria-current','page');
      });
    })();

    // ============== LEADERBOARD (reads saved 9-hole scores) ==============
    (function(){
      const SHARED_KEY = "ozarkShared_v1";
      const SCORE_NS   = "ozarkScores9_v1"; // keys: ozarkScores9_v1:<day>:<side>:<group>
      const TEAM_LABELS = { ozark: "Team Ozark", valley: "Team Valley" };
      const TEAM_FORMATS = new Set(['Best Ball','Scramble','Alt Shot','Shamble']); // team = 2v2, singles otherwise

      // URL param helpers / defaults
      function qs(name, def){ const u=new URL(location.href); return u.searchParams.get(name) || def; }
      const fDay  = document.getElementById('fDay');
      const fSide = document.getElementById('fSide');
      fDay.value  = (qs('day','all').toLowerCase()==='day2') ? 'day2' : (qs('day','all').toLowerCase()==='day1' ? 'day1':'all');
      fSide.value = (['front','back'].includes(qs('side','all').toLowerCase())) ? qs('side','all').toLowerCase() : 'all';

      const elOz   = document.getElementById('scoreOz');
      const elVa   = document.getElementById('scoreVa');
      const bar    = document.getElementById('barFill');
      const tbody  = document.getElementById('tbody');
      const note   = document.getElementById('filterNote');
      const evtBadge = document.getElementById('eventNameBadge');

      let shared=null, LAST_TS=0;

      fDay.addEventListener('change', renderAll);
      fSide.addEventListener('change', renderAll);

      // --- helpers for reading saved card data
      function storageKey(day, side, group){ return `${SCORE_NS}:${day}:${side}:${group}`; }
      function readJSON(key){ try{ return JSON.parse(localStorage.getItem(key)||'null'); }catch{ return null; } }

      function sumHoles9(arr){
        if (!Array.isArray(arr)) return null;
        let s=0, has=false;
        for (let i=0;i<9;i++){
          const v = parseInt(arr[i],10);
          if (!isNaN(v)){ s+=v; has=true; }
        }
        return has ? s : null;
      }

      // Returns { p0, p1, p2, p3 } totals or nulls
      function readGroupTotals(day, side, group){
        const data = readJSON(storageKey(day, side, group));
        if (!data || !Array.isArray(data.players)) return { p0:null,p1:null,p2:null,p3:null };
        const get = i => {
          const row = data.players[i];
          return row ? sumHoles9(row.holes9) : null;
        };
        return { p0:get(0), p1:get(1), p2:get(2), p3:get(3) };
      }

      // Decide winners and points for a group
      // For team formats: slots [0,1]=Ozark vs [2,3]=Valley (lower total wins 1 pt)
      // For singles: (0 vs 1) and (2 vs 3), each worth 1 pt
      function evaluateGroup(day, side, fmt, gIndex){
        const teamEvent = TEAM_FORMATS.has(fmt);
        const totals = readGroupTotals(day, side, gIndex+1); // group numbers are 1-based in keys
        const out = { teamEvent, results: [], pointsOz:0, pointsVa:0 };

        if (teamEvent){
          const oz = (totals.p0 ?? null) + (totals.p1 ?? null);
          const va = (totals.p2 ?? null) + (totals.p3 ?? null);

          const validOz = Number.isFinite(totals.p0) || Number.isFinite(totals.p1);
          const validVa = Number.isFinite(totals.p2) || Number.isFinite(totals.p3);

          if (Number.isFinite(oz) && Number.isFinite(va)){
            if (oz < va){ out.results = ['ozark', oz, va]; out.pointsOz += 1; }
            else if (va < oz){ out.results = ['valley', oz, va]; out.pointsVa += 1; }
            else { out.results = ['tie', oz, va]; out.pointsOz += .5; out.pointsVa += .5; }
          } else {
            out.results = [null, Number.isFinite(oz)?oz:null, Number.isFinite(va)?va:null];
          }
          return out;
        } else {
          // singles two matches
          const m1 = { a: totals.p0, b: totals.p1 }; // match 1: slots 0 vs 1
          const m2 = { a: totals.p2, b: totals.p3 }; // match 2: slots 2 vs 3
          const evalMatch = ({a,b})=>{
            if (Number.isFinite(a) && Number.isFinite(b)){
              if (a<b){ out.pointsOz+=1; return 'ozark'; }
              if (b<a){ out.pointsVa+=1; return 'valley'; }
              out.pointsOz+=.5; out.pointsVa+=.5; return 'tie';
            }
            return null;
          };
          out.results = [evalMatch(m1), evalMatch(m2), m1, m2]; // include raw totals for display
          return out;
        }
      }

      function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

      function playerName(p){
        if (!p) return '';
        const nick = p.nickname && p.nickname.trim().length ? ` "${p.nickname}"` : '';
        return `${p.firstName||''}${nick} ${p.lastName||''}`.replace(/\s+/g,' ').trim();
      }

      function buildRowHTML(day, side, fmt, gIndex, snap){
        const teamEvent = TEAM_FORMATS.has(fmt);
        const dayLabel  = (day==='day1')?'Day 1':'Day 2';
        const sideLabel = (side==='front')?'Front 9':'Back 9';
        const groupNum  = gIndex+1;

        const g = snap.groups?.[day]?.[side]?.[gIndex] || [];
        const byId = new Map((snap.players||[]).map(p=>[String(p.id), p]));
        const names = g.map(id=>byId.get(String(id)));

        const res = evaluateGroup(day, side, fmt, gIndex);

        if (teamEvent){
          const a = [names[0],names[1]].filter(Boolean).map(playerName).join(' & ');
          const b = [names[2],names[3]].filter(Boolean).map(playerName).join(' & ');

          const [winner, ozTot, vaTot] = res.results;
          let line = `<span class="muted">Awaiting scores</span>`;
          if (winner){
            const scoreTxt = Number.isFinite(ozTot) && Number.isFinite(vaTot) ? ` <span class="small muted">(${ozTot} vs ${vaTot})</span>` : '';
            if (winner==='ozark') line = `<span class="winner oz">Team Ozark</span>${scoreTxt}`;
            else if (winner==='valley') line = `<span class="winner va">Team Valley</span>${scoreTxt}`;
            else line = `<span class="winner">Tie</span>${scoreTxt}`;
          } else if (Number.isFinite(ozTot) || Number.isFinite(vaTot)){
            const scoreTxt = ` <span class="small muted">(${Number.isFinite(ozTot)?ozTot:'—'} vs ${Number.isFinite(vaTot)?vaTot:'—'})</span>`;
            line = `<span class="muted">Partial</span>${scoreTxt}`;
          }

          const pairs = (a||b) ? `<div class="small muted">${a||'—'} <strong>vs</strong> ${b||'—'}</div>` : '';
          return `
            <tr>
              <td>${dayLabel}</td>
              <td>${sideLabel}</td>
              <td>${fmt}</td>
              <td>${groupNum}</td>
              <td>${line}${pairs}</td>
            </tr>`;
        } else {
          // singles: two matches with totals if available
          const m1Names = `<span class="small muted">${playerName(names[0])||'—'} <strong>vs</strong> ${playerName(names[1])||'—'}</span>`;
          const m2Names = `<span class="small muted">${playerName(names[2])||'—'} <strong>vs</strong> ${playerName(names[3])||'—'}</span>`;
          const [r1, r2, m1, m2] = res.results;

          const mk = (lab, r, m) => {
            let who = '<span class="muted small">Awaiting scores</span>';
            if (r==='ozark') who = `<span class="winner oz small">${TEAM_LABELS.ozark}</span>`;
            else if (r==='valley') who = `<span class="winner va small">${TEAM_LABELS.valley}</span>`;
            else if (r==='tie') who = `<span class="winner small">Tie</span>`;
            const score = (Number.isFinite(m?.a) || Number.isFinite(m?.b))
              ? ` <span class="small muted">(${Number.isFinite(m?.a)?m.a:'—'} vs ${Number.isFinite(m?.b)?m.b:'—'})</span>`
              : '';
            return `<div>${lab}: ${who}${score}</div>`;
          };

          return `
            <tr>
              <td>${dayLabel}</td>
              <td>${sideLabel}</td>
              <td>${fmt}</td>
              <td>${groupNum}</td>
              <td>
                ${mk('Match 1', r1, m1)}<br>${m1Names}
                <br>
                ${mk('Match 2', r2, m2)}<br>${m2Names}
              </td>
            </tr>`;
        }
      }

      function computeTotals(snap){
        let oz=0, va=0, total=0;
        const considerDay  = fDay.value;
        const considerSide = fSide.value;

        ['day1','day2'].forEach(day=>{
          if (considerDay!=='all' && considerDay!==day) return;
          ['front','back'].forEach(side=>{
            if (considerSide!=='all' && considerSide!==side) return;

            const fmt = snap.format?.[day]?.[side] || 'Best Ball';
            const teamEvent = TEAM_FORMATS.has(fmt);
            const groups = snap.groups?.[day]?.[side] || [];

            for (let i=0;i<groups.length;i++){
              const ev = evaluateGroup(day, side, fmt, i);
              if (teamEvent){
                const decided = (ev.results[0] === 'ozark' || ev.results[0] === 'valley' || ev.results[0] === 'tie');
                if (decided){
                  total += 1;
                  oz += ev.pointsOz;
                  va += ev.pointsVa;
                }
              } else {
                // two singles; count only matches that have a decision
                const [r1, r2] = ev.results;
                if (r1){ total += 1; oz += (r1==='ozark'?1:(r1==='tie'?.5:0)); va += (r1==='valley'?1:(r1==='tie'?.5:0)); }
                if (r2){ total += 1; oz += (r2==='ozark'?1:(r2==='tie'?.5:0)); va += (r2==='valley'?1:(r2==='tie'?.5:0)); }
              }
            }
          });
        });
        return { oz, va, total };
      }

      function rebuildTable(snap){
        const considerDay  = fDay.value;
        const considerSide = fSide.value;
        let rows = '';

        ['day1','day2'].forEach(day=>{
          if (considerDay!=='all' && considerDay!==day) return;
          ['front','back'].forEach(side=>{
            if (considerSide!=='all' && considerSide!==side) return;

            const fmt = snap.format?.[day]?.[side] || 'Best Ball';
            const groups = snap.groups?.[day]?.[side] || [];
            for (let i=0;i<groups.length;i++){
              rows += buildRowHTML(day, side, fmt, i, snap);
            }
          });
        });

        tbody.innerHTML = rows || `<tr><td colspan="5" class="muted">No pairings/scores yet.</td></tr>`;

        const parts = [];
        if (considerDay!=='all') parts.push(considerDay==='day1'?'Day 1':'Day 2');
        if (considerSide!=='all') parts.push(considerSide==='front'?'Front 9':'Back 9');
        note.textContent = parts.length ? `Showing ${parts.join(' • ')}` : 'Showing all rounds';
      }

      function renderTotals(snap){
        const {oz, va, total} = computeTotals(snap);
        const ozR = Math.round(oz*10)/10, vaR = Math.round(va*10)/10;
        elOz.textContent = ozR.toString();
        elVa.textContent = vaR.toString();

        const denom = total>0 ? total : 1;
        const pctOz = Math.max(0, Math.min(100, (oz/denom)*100));
        bar.style.width = pctOz + '%';

        // Event name badge
        const evName = snap.eventName || 'Event';
        evtBadge.textContent = evName;
      }

      function adoptShared(raw){
        shared = raw; LAST_TS = raw.ts || Date.now();
        renderAll();
      }

      function renderAll(){
        if (!shared) return;
        renderTotals(shared);
        rebuildTable(shared);
      }

      function refreshFromStorage(){
        try{
          const raw = localStorage.getItem(SHARED_KEY);
          if (!raw) return;
          const snap = JSON.parse(raw);
          if (!snap) return;
          adoptShared(snap);
        }catch(e){ console.warn('[leaderboard] parse error', e); }
      }

      // Boot
      refreshFromStorage();

      // React to scoreboard writes (pairings/format/metadata)
      window.addEventListener('storage', (e)=>{
        // Pairings/format changes
        if (e.key === SHARED_KEY && e.newValue){
          let inc; try{ inc = JSON.parse(e.newValue); }catch{ return; }
          if (!inc || !inc.ts || inc.ts <= LAST_TS) return;
          adoptShared(inc);
          return;
        }
        // Score changes: any key that starts with ozarkScores9_v1:
        if (e.key && e.key.startsWith(`${SCORE_NS}:`)){
          // Re-render using current shared snapshot
          renderAll();
        }
      });

      // Also poll once in case scores already exist (simple micro-tick)
      setTimeout(renderAll, 0);
    })();
  </script>
</body>
</html>
