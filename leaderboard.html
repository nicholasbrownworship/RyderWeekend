<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard â€“ Ozark Invitational</title>

  <!-- Site-wide styles & scripts (for topbar, buttons, etc.) -->
  <link rel="stylesheet" href="styles.css" />
  <script src="script.js" defer></script>

  <style>
    :root{
      --green:#244f3c; --green-dark:#163023; --gold:#d1a14b; --cream:#f5f0e6; --bg:#fcfaf6; --text:#222;
      --panel:#ffffff; --line:#e7e0d1;
      --radius:16px; --shadow:0 14px 38px rgba(0,0,0,.06);
      --ink:#1f2937;
      --muted:#6b7280;
      --oz:#2ecc71;  /* Ozark */
      --va:#3498db;  /* Valley */
      --win:#10b981; --tie:#f59e0b; --lose:#ef4444;
    }

    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      padding-top:70px;
      color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
    }

    .wrap{max-width:1100px;margin:88px auto 20px;padding:12px}

    .hdr{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;border-radius:999px;background:var(--green);color:#fff;display:grid;place-items:center;font-weight:800}
    .title{font-weight:800;letter-spacing:-.01em}
    .sub{opacity:.7;font-size:.9rem;margin-top:-2px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--green);color:#fff;border:none;border-radius:999px;padding:.5rem 1rem;font-weight:700;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--green);border:1px solid var(--green)}

    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#fff}
    .card .body{padding:12px 14px}

    /* clickable match card wrapper */
    .match-link{
      text-decoration:none;
      color:inherit;
      display:block;
    }
    .match-link:hover .match-card{
      transform:translateY(-1px);
      box-shadow:0 18px 40px rgba(0,0,0,.12);
    }

    /* ===== Scoreboard header ===== */
    .totals{
      display:grid;
      grid-template-columns:1fr minmax(220px, 380px) 1fr;
      gap:14px;
      align-items:center;
    }
    .teamBox{display:flex;flex-direction:column;gap:6px}
    .teamName{font-weight:800;letter-spacing:.02em;color:var(--ink);display:flex;align-items:center;gap:8px}
    .teamScore{font-size:2.25rem;font-weight:900;line-height:1}
    .dot{display:inline-block;width:12px;height:12px;border-radius:50%}
    .dot.oz{background:var(--oz)} .dot.va{background:var(--va)}

    .scorebar{
      border:1px solid #e5dfd0;
      border-radius:14px;
      padding:10px;
      background:linear-gradient(180deg,#fff, #fbfaf6);
      display:grid;
      gap:8px;
    }
    .bar{
      height:16px;
      background:#eee;
      border-radius:999px;
      overflow:hidden;
      border:1px solid #ddd;
      position:relative;
    }
    .bar > div{height:100%}
    .scoreMeta{display:flex;align-items:center;justify-content:space-between;font-size:.85rem;color:var(--muted)}
    .crown{
      border:1px solid var(--line);
      background:#fff3d1;
      color:#7a5b00;
      border-radius:999px;
      padding:.2rem .6rem;
      font-size:.8rem;
      font-weight:700;
    }

    .filters{display:flex;gap:8px;flex-wrap:wrap}
    select{
      padding:.5rem .7rem;
      border:1px solid #d9d2c4;
      border-radius:10px;
      background:#fff;
      font:inherit;
    }
    select:disabled{ opacity:.6; cursor:not-allowed; }
    .badge{
      border:1px solid #d9d2c4;
      border-radius:999px;
      padding:.2rem .5rem;
      background:#fff;
      font-size:.75rem;
    }

    /* ===== Match list (single-column, grouped) ===== */
    .matches-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:6px;
    }
    .note{font-size:.85rem;color:var(--muted)}

    .match-grid{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .round-section{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:12px;
    }
    .round-section-title{
      font-size:.85rem;
      font-weight:600;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .match-card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:var(--shadow);
      overflow:visible; /* allow ribbon to extend */
      position:relative;
      transition:box-shadow .12s ease, transform .12s ease;
    }

    /* Corner ribbon */
    .ribbon{
      position:absolute;
      top:10px;
      right:-32px;
      transform:rotate(40deg);
      width:100px;
      text-align:center;
      padding:.28rem 0;
      color:#fff;
      font-weight:800;
      font-size:.72rem;
      letter-spacing:.06em;
      box-shadow:0 8px 18px rgba(0,0,0,.18);
      z-index:2;
      display:none;
    }
    .match-card.win-oz .ribbon{ display:block; background:var(--oz) }
    .match-card.win-va .ribbon{ display:block; background:var(--va) }
    .match-card.tie   .ribbon{ display:block; background:var(--tie) }

    .mc-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px dashed #e9e2d2;
      padding:10px 12px;
      background:#fff;
    }
    .roundTag{
      font-weight:800;
      color:var(--ink);
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .tag{
      border:1px solid #eadfca;
      background:#fff;
      border-radius:999px;
      padding:.15rem .55rem;
      font-size:.78rem;
    }
    .fmt{font-weight:800}

    .mc-body{ padding:12px }
    .teams{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      gap:10px;
      align-items:center;
    }
    .pair{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .name{font-weight:700}
    .name.small{font-size:.92rem}

    /* âœ… Team bubble â€“ SAME size behavior both sides */
    .teamChip{
      display:inline-flex !important;
      align-items:center;
      justify-content:center;
      gap:6px;

      padding:0.15rem 0.6rem;
      font-size:0.75rem;
      line-height:1;
      font-weight:600;

      border-radius:999px;
      border:1px solid #e8e1d2;
      background:#fff;

      white-space:nowrap;
      flex:0 0 auto;
      width:auto !important;
      max-width:max-content;
    }
    .teamChip .dot{
      width:10px;
      height:10px;
    }
    .teamChip.oz{ border-color: rgba(46,204,113,.35); }
    .teamChip.va{ border-color: rgba(52,152,219,.35); }

    .vs{
      font-weight:800;
      color:#8b8b8b;
      letter-spacing:.06em;
    }
    .scorePill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      font-weight:800;
      border-radius:999px;
      padding:.15rem .5rem;
      font-size:.8rem;
      border:1px solid #ece6d6;
      background:#f9f7f0;
    }
    .scorePill.win{ border-color: rgba(16,185,129,.35); background:#f0fcf6 }
    .scorePill.tie{ border-color: rgba(245,158,11,.35); background:#fff8ec }
    .scorePill.partial{ border-color:#e6e0d2; background:#fff }

    .singles{
      margin-top:8px;
      border-top:1px dashed #eee;
      padding-top:8px;
      display:grid;
      gap:8px;
    }
    .singles .row{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      gap:10px;
      align-items:center;
    }

    .empty{
      padding:16px;
      border:1px dashed #e5dfd0;
      border-radius:12px;
      text-align:center;
      color:var(--muted);
      background:#fff;
    }
  </style>
</head>
<body>

  <div id="siteHeader"></div>
  <script>
    fetch("header.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("siteHeader").innerHTML = html;

        // Current tab highlight (GitHub Pages-safe)
        const here = (location.pathname.split('/').pop() || 'index.html').toLowerCase();
        document.querySelectorAll('.nav a').forEach(a => {
          const target = (a.getAttribute('href') || '').split('#')[0] || 'index.html';
          if (target.toLowerCase() === here) a.setAttribute('aria-current','page');
        });

        // Kick the small header widget if script.js defined it
        if (window.initTeamScoreWidget) {
          window.initTeamScoreWidget();
        }
      });
  </script>

  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <div class="logo">OI</div>
        <div>
          <div class="title">Ozark Invitational â€” Leaderboard</div>
          <div class="sub">Live team totals &amp; round-by-round results</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="window.print()">Print</button>
      </div>
    </div>

    <!-- Totals card -->
    <section class="card" style="margin-bottom:12px">
      <div class="head">
        <div class="filters">
          <label class="small">Day
            <select id="fDay">
              <option value="all">All</option>
              <option value="day1">Day 1</option>
              <option value="day2">Day 2</option>
            </select>
          </label>
          <label class="small">Side
            <select id="fSide">
              <option value="all">All</option>
              <option value="front">Front 9</option>
              <option value="back">Back 9</option>
            </select>
          </label>
        </div>
        <div class="badge small" id="eventNameBadge">Event</div>
      </div>
      <div class="body">
        <div class="totals">
          <div class="teamBox">
            <div class="teamName"><span class="dot oz"></span><span id="teamLabelOz">Team Ozark</span></div>
            <div class="teamScore" id="scoreOz">0</div>
          </div>

          <div class="scorebar" aria-label="Match progress">
            <div class="bar">
              <div id="barFill" style="width:50%; background:linear-gradient(90deg, var(--oz), var(--va));"></div>
            </div>
            <div class="scoreMeta">
              <span class="small" id="scoreMetaLeft">Round points</span>
              <span class="crown" id="crownTag" hidden>Currently Leading</span>
              <span class="small" id="scoreMetaRight">Higher bar = Ozark</span>
            </div>
          </div>

          <div class="teamBox" style="align-items:end;text-align:right">
            <div class="teamName"><span class="dot va"></span><span id="teamLabelVa">Team Valley</span></div>
            <div class="teamScore" id="scoreVa">0</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Match cards -->
    <section class="card">
      <div class="head matches-head">
        <strong>Round Results</strong>
        <span class="note" id="filterNote"></span>
      </div>
      <div class="body">
        <div id="matchGrid" class="match-grid"></div>
        <div id="emptyState" class="empty" hidden>No pairings/scores yet.</div>
      </div>
    </section>
  </div>

  <!-- Tiny inline helpers for the shared header + leaderboard logic -->
  <script>
    // Mobile menu toggle
    (function () {
      const btn = document.getElementById('navToggle');
      const nav = document.querySelector('.nav');
      if (!btn || !nav) return;
      btn.addEventListener('click', () => {
        const open = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', String(!open));
        nav.classList.toggle('open', !open);
      });
    })();

    // Current tab highlight (defensive double, safe if header already did it)
    (function(){
      const here = (location.pathname.split('/').pop() || 'index.html').toLowerCase();
      document.querySelectorAll('.nav a').forEach(a => {
        const target = (a.getAttribute('href') || '').split('#')[0] || 'index.html';
        if (target.toLowerCase() === here) a.setAttribute('aria-current','page');
      });
    })();

    // ============== LEADERBOARD (dual-source: Captain Console OR scorecards) ==============
    (function(){
      // Existing system
      const SHARED_KEY = "ozarkShared_v1";
      const SCORE_NS   = "ozarkScores9_v1"; // keys: ozarkScores9_v1:<day>:<side>:<group>

      // New source: Captainâ€™s Console
      const CAPTAINS_KEY = "rw_captains_console_v2";

      // DOM
      const fDay  = document.getElementById('fDay');
      const fSide = document.getElementById('fSide');
      const elOz  = document.getElementById('scoreOz');
      const elVa  = document.getElementById('scoreVa');
      const bar   = document.getElementById('barFill');
      const crown = document.getElementById('crownTag');
      const grid  = document.getElementById('matchGrid');
      const empty = document.getElementById('emptyState');
      const note  = document.getElementById('filterNote');
      const evtBadge = document.getElementById('eventNameBadge');
      const teamLabelOz = document.getElementById('teamLabelOz');
      const teamLabelVa = document.getElementById('teamLabelVa');

      let shared = null, LAST_TS = 0;

      // URL param helpers / defaults (for the old scorecard mode)
      function qs(name, def){
        const u = new URL(location.href);
        return u.searchParams.get(name) || def;
      }
      fDay.value  = (qs('day','all').toLowerCase()==='day2')
        ? 'day2'
        : (qs('day','all').toLowerCase()==='day1' ? 'day1':'all');
      fSide.value = (['front','back'].includes(qs('side','all').toLowerCase()))
        ? qs('side','all').toLowerCase()
        : 'all';

      function readJSON(key){
        try{ return JSON.parse(localStorage.getItem(key)||'null'); }
        catch{ return null; }
      }

      function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
      function round1(v){ return Math.round((Number(v)||0) * 10) / 10; }

      // ------------------------------
      // Captainâ€™s Console mode
      // ------------------------------
      function readCaptains(){
        const st = readJSON(CAPTAINS_KEY);
        if(!st || !Array.isArray(st.matches) || st.matches.length === 0) return null;
        return st;
      }

      function captainsTotals(st){
        const oz = round1(st.matches.reduce((s,m)=> s + (Number(m.pointsA)||0), 0));
        const va = round1(st.matches.reduce((s,m)=> s + (Number(m.pointsB)||0), 0));
        const denom = (oz + va);
        const pctOz = denom > 0 ? clamp((oz/denom)*100, 0, 100) : 50;
        return { oz, va, pctOz };
      }

      // Keep your header widget totals in sync by writing to ozarkShared_v1.teamScores
      function pushHeaderWidgetTeamScores(oz, va, st){
        try{
          const raw = localStorage.getItem(SHARED_KEY);
          const snap = raw ? JSON.parse(raw) : {};
          const base = (snap && typeof snap === 'object') ? { ...snap } : {};
          base.teamScores = { ozark: oz, valley: va };
          if (st?.eventName) base.eventName = st.eventName;
          base.ts = Date.now();
          localStorage.setItem(SHARED_KEY, JSON.stringify(base));
          if (window.initTeamScoreWidget) window.initTeamScoreWidget();
        }catch(e){
          console.warn("[leaderboard] failed to update shared teamScores from captains", e);
        }
      }

      function matchLabelFromCaptains(st, m){
        const A = st?.teams?.A?.name || "Ozark";
        const B = st?.teams?.B?.name || "Valley";
        if (m.result === "pending") return "Pending";
        if (m.result === "halve") return "Halved";
        if (m.result === "A") return `${A} wins`;
        if (m.result === "B") return `${B} wins`;
        return "Pending";
      }

      function esc(s){
        return String(s ?? "")
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;");
      }

      function captainsCard(m, st){
        const A = st?.teams?.A?.name || "Ozark";
        const B = st?.teams?.B?.name || "Valley";

        const fmt = (m.format || "Match").trim();
        const id  = (m.id || "").trim() || "â€”";
        const tee = (m.teeTime || "").trim();

        const winner =
          (m.result === "A") ? "ozark" :
          (m.result === "B") ? "valley" :
          (m.result === "halve") ? "tie" : null;

        let cardClass = "";
        if (winner === "ozark") cardClass = "win-oz";
        else if (winner === "valley") cardClass = "win-va";
        else if (winner === "tie") cardClass = "tie";

        const ribbonText = (winner === "ozark") ? A : (winner === "valley") ? B : (winner === "tie") ? "Tie" : "";

        const ozNames = (Array.isArray(m.teamAPlayers) && m.teamAPlayers.length)
          ? m.teamAPlayers.join(" & ")
          : "â€”";
        const vaNames = (Array.isArray(m.teamBPlayers) && m.teamBPlayers.length)
          ? m.teamBPlayers.join(" & ")
          : "â€”";

        const pillText = `${round1(m.pointsA)} â€“ ${round1(m.pointsB)}`;
        const pillClass =
          winner ? (winner === "tie" ? "scorePill tie" : "scorePill win")
                 : "scorePill partial";

        const label = matchLabelFromCaptains(st, m);

        const roundTag = `
          <div class="roundTag">
            <span class="tag">${esc(id)}</span>
            <span class="tag fmt">${esc(fmt)}</span>
            ${tee ? `<span class="tag">${esc(tee)}</span>` : ``}
          </div>
        `;

        const chipOz = `<span class="teamChip oz"><span class="dot oz"></span>${esc(A)}</span>`;
        const chipVa = `<span class="teamChip va"><span class="dot va"></span>${esc(B)}</span>`;

        // Link to the console for edits (safe fallback to "#" if path differs)
        const linkHref = `admin/captains-console.html`;

        return `
          <a class="match-link" href="${linkHref}">
            <div class="match-card ${cardClass}">
              <div class="ribbon">${esc(ribbonText)}</div>
              <div class="mc-head">
                ${roundTag}
                <span class="${pillClass}">${esc(pillText)}</span>
              </div>
              <div class="mc-body">
                <div class="teams">
                  <div class="pair">
                    <div class="name">${esc(ozNames)}</div>
                    ${chipOz}
                  </div>
                  <div class="vs">${esc(label)}</div>
                  <div class="pair" style="text-align:right; align-items:flex-end">
                    <div class="name">${esc(vaNames)}</div>
                    ${chipVa}
                  </div>
                </div>
                ${m.notes ? `<div class="note" style="margin-top:10px;">Note: ${esc(String(m.notes)).slice(0,180)}</div>` : ``}
              </div>
            </div>
          </a>
        `;
      }

      function renderCaptains(st){
        // Disable Day/Side filters because Captain matches donâ€™t have day/side metadata
        fDay.value = "all";
        fSide.value = "all";
        fDay.disabled = true;
        fSide.disabled = true;

        const A = st?.teams?.A?.name || "Team Ozark";
        const B = st?.teams?.B?.name || "Team Valley";
        teamLabelOz.textContent = A;
        teamLabelVa.textContent = B;

        const totals = captainsTotals(st);
        elOz.textContent = String(totals.oz);
        elVa.textContent = String(totals.va);
        bar.style.width = totals.pctOz + "%";

        crown.hidden = !(totals.oz > totals.va || totals.va > totals.oz);
        crown.textContent =
          (totals.oz > totals.va) ? `${A} Leading` :
          (totals.va > totals.oz) ? `${B} Leading` : "Currently Tied";

        evtBadge.textContent = (st.eventName || "Event");
        note.textContent = `Source: Captainâ€™s Console â€¢ ${st.sessionName || "Session"}`;

        // Cards
        const matches = Array.isArray(st.matches) ? st.matches : [];
        let html = '';
        const title = (st.sessionName || "Captain Pairings & Results").toUpperCase();
        html += `<div class="round-section"><div class="round-section-title">${esc(title)}</div>`;

        for (const m of matches){
          html += captainsCard(m, st);
        }
        html += `</div>`;

        grid.innerHTML = html;
        empty.hidden = matches.length > 0;

        // Sync header widget
        pushHeaderWidgetTeamScores(totals.oz, totals.va, st);
      }

      // ------------------------------
      // Existing scorecard mode (your original logic)
      // ------------------------------
      const TEAM_FORMATS = new Set(['Best Ball','Scramble','Alt Shot','Shamble']); // team = 2v2, singles otherwise

      fDay.addEventListener('change', () => {
        const capt = readCaptains();
        if (!capt) renderAllScorecards();
      });
      fSide.addEventListener('change', () => {
        const capt = readCaptains();
        if (!capt) renderAllScorecards();
      });

      function storageKey(day, side, group){
        return `${SCORE_NS}:${day}:${side}:${group}`;
      }

      function sumHoles9(arr){
        if (!Array.isArray(arr)) return null;
        let s=0, has=false;
        for (let i=0;i<9;i++){
          const v = parseInt(arr[i],10);
          if (!isNaN(v)){ s+=v; has=true; }
        }
        return has ? s : null;
      }

      // Returns { p0, p1, p2, p3 } totals or nulls
      function readGroupTotals(day, side, group){
        const data = readJSON(storageKey(day, side, group));
        if (!data || !Array.isArray(data.players)) return { p0:null,p1:null,p2:null,p3:null };
        const get = i => {
          const row = data.players[i];
          return row ? sumHoles9(row.holes9) : null;
        };
        return { p0:get(0), p1:get(1), p2:get(2), p3:get(3) };
      }

      function evaluateGroup(day, side, fmt, gIndex){
        const teamEvent = TEAM_FORMATS.has(fmt);
        const totals = readGroupTotals(day, side, gIndex+1);
        const out = { teamEvent, results: [], pointsOz:0, pointsVa:0, totals };

        if (teamEvent){
          const oz = (Number.isFinite(totals.p0)?totals.p0:0) + (Number.isFinite(totals.p1)?totals.p1:0);
          const va = (Number.isFinite(totals.p2)?totals.p2:0) + (Number.isFinite(totals.p3)?totals.p3:0);
          const validOz = Number.isFinite(totals.p0) || Number.isFinite(totals.p1);
          const validVa = Number.isFinite(totals.p2) || Number.isFinite(totals.p3);

          if (validOz && validVa && Number.isFinite(oz) && Number.isFinite(va)){
            if (oz < va){ out.results = ['ozark', oz, va]; out.pointsOz += 1; }
            else if (va < oz){ out.results = ['valley', oz, va]; out.pointsVa += 1; }
            else { out.results = ['tie', oz, va]; out.pointsOz += 0.5; out.pointsVa += 0.5; }
          } else {
            out.results = [null, validOz?oz:null, validVa?va:null];
          }
          return out;
        } else {
          const m1 = { a: totals.p0, b: totals.p1 }; // 0 vs 1
          const m2 = { a: totals.p2, b: totals.p3 }; // 2 vs 3
          const evalMatch = ({a,b})=>{
            if (Number.isFinite(a) && Number.isFinite(b)){
              if (a<b){ out.pointsOz+=1; return 'ozark'; }
              if (b<a){ out.pointsVa+=1; return 'valley'; }
              out.pointsOz+=0.5; out.pointsVa+=0.5; return 'tie';
            }
            return null;
          };
          out.results = [evalMatch(m1), evalMatch(m2), m1, m2];
          return out;
        }
      }

      function playerName(p){
        if (!p) return '';
        const nick = p.nickname && p.nickname.trim().length ? ` "${p.nickname}"` : '';
        return `${p.firstName||''}${nick} ${p.lastName||''}`.replace(/\s+/g,' ').trim();
      }

      function cardForTeam(day, side, fmt, gIndex, snap){
        const teamEvent = TEAM_FORMATS.has(fmt);
        const dayLabel  = (day==='day1')?'Day 1':'Day 2';
        const sideLabel = (side==='front')?'Front 9':'Back 9';
        const groupNum  = gIndex+1;
        const g = snap.groups?.[day]?.[side]?.[gIndex] || [];
        const byId = new Map((snap.players||[]).map(p=>[String(p.id), p]));
        const names = g.map(id=>byId.get(String(id)));

        const res = evaluateGroup(day, side, fmt, gIndex);

        const chipOz = `<span class="teamChip oz"><span class="dot oz"></span>Ozark</span>`;
        const chipVa = `<span class="teamChip va"><span class="dot va"></span>Valley</span>`;

        const roundTag = `
          <div class="roundTag">
            <span class="tag">${dayLabel}</span>
            <span class="tag">${sideLabel}</span>
            <span class="tag fmt">${fmt}</span>
            <span class="tag">Group ${groupNum}</span>
          </div>
        `;

        // ðŸ”— Link to the correct scorecard round
        const linkHref = `scorecard.html?day=${encodeURIComponent(day)}&side=${encodeURIComponent(side)}&group=${groupNum}`;
        const linkOpen = `<a class="match-link" href="${linkHref}">`;
        const linkClose = `</a>`;

        if (teamEvent){
          const ozNames = [names[0],names[1]].filter(Boolean).map(playerName).join(' & ') || 'â€”';
          const vaNames = [names[2],names[3]].filter(Boolean).map(playerName).join(' & ') || 'â€”';

          const [winner, ozTot, vaTot] = res.results;

          let cardClass = '';
          let pillClass = 'scorePill partial';
          let pillText  = 'Awaiting scores';
          if (winner === 'ozark'){ cardClass='win-oz'; pillClass='scorePill win'; pillText=`${ozTot} â€“ ${vaTot}`; }
          else if (winner === 'valley'){ cardClass='win-va'; pillClass='scorePill win'; pillText=`${vaTot} â€“ ${ozTot}`; }
          else if (winner === 'tie'){ cardClass='tie'; pillClass='scorePill tie'; pillText=`${ozTot} â€“ ${vaTot} (Tie)`; }
          else if (Number.isFinite(ozTot) || Number.isFinite(vaTot)){
            pillText=`${Number.isFinite(ozTot)?ozTot:'â€”'} â€“ ${Number.isFinite(vaTot)?vaTot:'â€”'}`;
          }

          return `
            ${linkOpen}
              <div class="match-card ${cardClass}">
                <div class="ribbon">${winner==='ozark'?'Ozark':winner==='valley'?'Valley':winner==='tie'?'Tie':''}</div>
                <div class="mc-head">
                  ${roundTag}
                  <span class="${pillClass}">${pillText}</span>
                </div>
                <div class="mc-body">
                  <div class="teams">
                    <div class="pair">
                      <div class="name">${ozNames}</div>
                      ${chipOz}
                    </div>
                    <div class="vs">VS</div>
                    <div class="pair" style="text-align:right; align-items:flex-end">
                      <div class="name">${vaNames}</div>
                      ${chipVa}
                    </div>
                  </div>
                </div>
              </div>
            ${linkClose}
          `;
        } else {
          const [r1, r2, m1, m2] = res.results;
          const mkRow = (A,B,r,m) => {
            const pill =
              r==='ozark' ? `<span class="scorePill win">${Number.isFinite(m?.a)?m.a:'â€”'} â€“ ${Number.isFinite(m?.b)?m.b:'â€”'}</span>` :
              r==='valley'? `<span class="scorePill win">${Number.isFinite(m?.b)?m.b:'â€”'} â€“ ${Number.isFinite(m?.a)?m.a:'â€”'}</span>` :
              r==='tie'   ? `<span class="scorePill tie">${Number.isFinite(m?.a)?m.a:'â€”'} â€“ ${Number.isFinite(m?.b)?m.b:'â€”'} (Tie)</span>` :
                            `<span class="scorePill partial">${Number.isFinite(m?.a)?m.a:'â€”'} â€“ ${Number.isFinite(m?.b)?m.b:'â€”'}</span>`;
            return `
              <div class="row">
                <div class="pair">
                  <div class="name small">${playerName(A)||'â€”'}</div>
                  ${chipOz}
                </div>
                <div class="vs">${pill}</div>
                <div class="pair" style="text-align:right; align-items:flex-end">
                  <div class="name small">${playerName(B)||'â€”'}</div>
                  ${chipVa}
                </div>
              </div>`;
          };

          let cls='';
          if (res.pointsOz > res.pointsVa) cls='win-oz';
          else if (res.pointsVa > res.pointsOz) cls='win-va';
          else if (res.pointsOz === res.pointsVa && (r1||r2)) cls='tie';

          return `
            ${linkOpen}
              <div class="match-card ${cls}">
                <div class="ribbon">${cls==='win-oz'?'Ozark':cls==='win-va'?'Valley':cls==='tie'?'Tie':''}</div>
                <div class="mc-head">
                  ${roundTag}
                  <span class="tag">Singles</span>
                </div>
                <div class="mc-body">
                  <div class="singles">
                    ${mkRow(names[0], names[1], r1, m1)}
                    ${mkRow(names[2], names[3], r2, m2)}
                  </div>
                </div>
              </div>
            ${linkClose}
          `;
        }
      }

      function computeTotalsScorecards(snap){
        let oz=0, va=0, total=0;
        const considerDay  = fDay.value;
        const considerSide = fSide.value;

        ['day1','day2'].forEach(day=>{
          if (considerDay!=='all' && considerDay!==day) return;
          ['front','back'].forEach(side=>{
            if (considerSide!=='all' && considerSide!==side) return;

            const fmt = snap.format?.[day]?.[side] || 'Best Ball';
            const teamEvent = TEAM_FORMATS.has(fmt);
            const groups = snap.groups?.[day]?.[side] || [];

            for (let i=0;i<groups.length;i++){
              const ev = evaluateGroup(day, side, fmt, i);
              if (teamEvent){
                const decided = (ev.results[0] === 'ozark' || ev.results[0] === 'valley' || ev.results[0] === 'tie');
                if (decided){
                  total += 1;
                  oz += ev.pointsOz;
                  va += ev.pointsVa;
                }
              } else {
                const [r1, r2] = ev.results;
                if (r1){
                  total += 1;
                  oz += (r1==='ozark'?1:(r1==='tie'?0.5:0));
                  va += (r1==='valley'?1:(r1==='tie'?0.5:0));
                }
                if (r2){
                  total += 1;
                  oz += (r2==='ozark'?1:(r2==='tie'?0.5:0));
                  va += (r2==='valley'?1:(r2==='tie'?0.5:0));
                }
              }
            }
          });
        });
        return { oz, va, total };
      }

      function rebuildGridScorecards(snap){
        const considerDay  = fDay.value;
        const considerSide = fSide.value;

        const parts = [];
        if (considerDay!=='all') parts.push(considerDay==='day1'?'Day 1':'Day 2');
        if (considerSide!=='all') parts.push(considerSide==='front'?'Front 9':'Back 9');
        note.textContent = parts.length ? `Showing ${parts.join(' â€¢ ')}` : 'Showing all rounds';

        let html = '';
        let count = 0;

        ['day1','day2'].forEach(day=>{
          if (considerDay!=='all' && considerDay!==day) return;
          const dayLabel = (day==='day1' ? 'Day 1' : 'Day 2');

          ['front','back'].forEach(side=>{
            if (considerSide!=='all' && considerSide!==side) return;

            const sideLabel = (side==='front' ? 'Front 9' : 'Back 9');
            const fmt = snap.format?.[day]?.[side] || 'Best Ball';
            const groups = snap.groups?.[day]?.[side] || [];
            if (!groups.length) return;

            html += `<div class="round-section"><div class="round-section-title">${dayLabel} â€¢ ${sideLabel}</div>`;

            for (let i=0;i<groups.length;i++){
              html += cardForTeam(day, side, fmt, i, snap);
              count++;
            }

            html += `</div>`;
          });
        });

        grid.innerHTML = html;
        empty.hidden = count>0;
      }

      function renderTotalsScorecards(snap){
        const {oz, va, total} = computeTotalsScorecards(snap);
        const ozR = Math.round(oz*10)/10;
        const vaR = Math.round(va*10)/10;

        elOz.textContent = ozR.toString();
        elVa.textContent = vaR.toString();

        const denom = total>0 ? total : 1;
        const pctOz = clamp((oz/denom)*100, 0, 100);
        bar.style.width = pctOz + '%';

        crown.hidden = !(oz>va || va>oz);
        crown.textContent = (oz>va)
          ? "Ozark Leading"
          : (va>oz)
          ? "Valley Leading"
          : "Currently Tied";

        const evName = snap.eventName || 'Event';
        evtBadge.textContent = evName;

        // Keep header widget scores updated
        try{
          if (!snap.teamScores || snap.teamScores.ozark !== ozR || snap.teamScores.valley !== vaR){
            const base = {...snap, teamScores:{ozark:ozR, valley:vaR}, ts: Date.now()};
            localStorage.setItem(SHARED_KEY, JSON.stringify(base));
            if (window.initTeamScoreWidget) window.initTeamScoreWidget();
          }
        }catch(e){
          console.warn("[leaderboard] failed to update shared teamScores", e);
        }
      }

      function adoptShared(raw){
        shared = raw;
        LAST_TS = raw.ts || Date.now();
        renderAllScorecards();
      }

      function renderAllScorecards(){
        if (!shared) return;

        // Ensure filters are enabled in scorecard mode
        fDay.disabled = false;
        fSide.disabled = false;

        // Fixed labels in this mode
        teamLabelOz.textContent = "Team Ozark";
        teamLabelVa.textContent = "Team Valley";

        renderTotalsScorecards(shared);
        rebuildGridScorecards(shared);
      }

      function refreshFromStorage(){
        try{
          const raw = localStorage.getItem(SHARED_KEY);
          if (!raw) return;
          const snap = JSON.parse(raw);
          if (!snap) return;
          adoptShared(snap);
        }catch(e){
          console.warn('[leaderboard] parse error', e);
        }
      }

      // ------------------------------
      // Boot: prefer Captainâ€™s Console if present
      // ------------------------------
      function boot(){
        const capt = readCaptains();
        if (capt){
          renderCaptains(capt);
          return;
        }
        refreshFromStorage();
        setTimeout(renderAllScorecards, 0);
      }

      // React to changes (either system)
      window.addEventListener('storage', (e)=>{
        // Captainâ€™s Console changed â†’ switch to / re-render captains mode
        if (e.key === CAPTAINS_KEY){
          const capt = readCaptains();
          if (capt){ renderCaptains(capt); return; }
          // If captains cleared, fall back
          refreshFromStorage();
          renderAllScorecards();
          return;
        }

        // Existing scorecard system
        if (e.key === SHARED_KEY && e.newValue){
          let inc; try{ inc = JSON.parse(e.newValue); }catch{ return; }
          if (!inc || !inc.ts || inc.ts <= LAST_TS) return;
          adoptShared(inc);
          return;
        }
        if (e.key && e.key.startsWith(`${SCORE_NS}:`)){
          // Only re-render scorecard mode if captains isn't active
          const capt = readCaptains();
          if (!capt) renderAllScorecards();
        }
      });

      boot();
    })();
  </script>
</body>
</html>
